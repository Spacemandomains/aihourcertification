<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upload JSON → /HAL JSON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://js.bytescale.com/upload-widget/v4"></script>
  <style>
    :root { --accent:#0f172a; --bg:#f8fafc; --card:#fff; }
    body { margin:0; background:var(--bg); color:#0b1220; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width:920px; margin:48px auto; padding:0 20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.07); padding:24px; }
    h1 { margin:0 0 8px; font-size:1.7rem; }
    p.sub { margin:0 0 18px; color:#51607a; }
    .dz { height:360px; border-radius:14px; overflow:hidden; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:14px; }
    .btn { background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .hint { color:#6b7280; font-size:.95rem; }
    .ok { color:#065f46; }
    .err { color:#991b1b; }
    .list { margin-top:16px; border-top:1px dashed #e5e7eb; padding-top:12px; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; gap:12px; border-bottom:1px dashed #eef2f7; }
    .name { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; word-break:break-all; }
    .meta { font-size:.9rem; color:#64748b; }
    progress { width:200px; height:10px; }
    textarea { width:100%; min-height:140px; border:1px solid #e5e7eb; background:#f3f4f6; border-radius:10px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Upload JSON Files</h1>
      <p class="sub">
        Destination: <code>/HAL JSON/&lt;file-name&gt;/&lt;file-name&gt;</code><br/>
        Drag &amp; drop or click. Any <strong>.json</strong> or <strong>.jsonl</strong> file is accepted.
      </p>

      <div id="dropzone" class="dz"></div>

      <div class="row">
        <button id="openModal" class="btn" type="button">Open Upload Modal</button>
        <span id="status" class="hint">Idle</span>
      </div>

      <div class="list" id="fileList"></div>

      <p class="hint" style="margin-top:10px;">Uploaded file URL(s):</p>
      <textarea id="urls" readonly placeholder="Uploaded URLs will appear here…"></textarea>
    </div>
  </div>

  <script>
    const BYTESCALE_PUBLIC_API_KEY = "public_kW2K8YP5GHft3yZZtLyk6P3MTtRC";

    // Each file goes into its own folder named after the file
    const UPLOAD_PATH = { path: "/HAL JSON/{ORIGINAL_FILE_NAME}" };

    // Simple check: only allow .json / .jsonl extensions
    async function allowJsonFiles(file) {
      const name = (file.name || "").toLowerCase();
      if (name.endsWith(".json") || name.endsWith(".jsonl")) {
        return { transformedFile: file };
      }
      return { errorMessage: "Only .json or .jsonl files are allowed." };
    }

    const fileMap = new Map(); // track UI rows

    const baseOptions = {
      apiKey: BYTESCALE_PUBLIC_API_KEY,
      path: UPLOAD_PATH,
      maxFileCount: 25,
      onPreUpload: allowJsonFiles,   // no parsing, just extension check
      showFinishButton: true,
      onUpdate: ({ uploadedFiles, pendingFiles, failedFiles }) => {
        const statusEl = document.getElementById("status");
        const urlsEl = document.getElementById("urls");
        const list = document.getElementById("fileList");

        [...pendingFiles, ...uploadedFiles, ...failedFiles].forEach(f => {
          if (!fileMap.has(f.fileId)) {
            const row = document.createElement("div");
            row.className = "item";
            const left = document.createElement("div");
            left.innerHTML = `<div class="name">${f.fileName}</div>
                              <div class="meta">${(f.fileSizeBytes || 0).toLocaleString()} bytes</div>`;
            const right = document.createElement("div");
            const prog = document.createElement("progress");
            prog.max = 1; prog.value = 0;
            right.appendChild(prog);
            row.appendChild(left);
            row.appendChild(right);
            list.appendChild(row);
            fileMap.set(f.fileId, { size: f.fileSizeBytes, el: row, progressEl: prog });
          }
        });

        pendingFiles.forEach(f => {
          const rec = fileMap.get(f.fileId);
          if (rec && typeof f.progress === "number") rec.progressEl.value = f.progress;
        });

        uploadedFiles.forEach(f => {
          const rec = fileMap.get(f.fileId);
          if (rec) {
            rec.progressEl.value = 1;
            rec.el.querySelector(".meta").textContent = `${(rec.size || 0).toLocaleString()} bytes • Uploaded`;
          }
        });

        const urls = uploadedFiles.map(f => f.fileUrl);
        if (urls.length) {
          urlsEl.value = (urlsEl.value ? urlsEl.value + "\n" : "") + urls.join("\n");
        }

        const up = uploadedFiles.length, pend = pendingFiles.length, fail = failedFiles.length;
        statusEl.textContent = `Uploaded: ${up} | Pending: ${pend} | Failed: ${fail}`;
        statusEl.className = "hint " + (fail > 0 ? "err" : (pend === 0 && up > 0 ? "ok" : ""));
      }
    };

    // Inline dropzone
    Bytescale.UploadWidget.open({
      ...baseOptions,
      layout: "inline",
      container: "#dropzone"
    });

    // Optional modal
    document.getElementById("openModal").addEventListener("click", () => {
      Bytescale.UploadWidget.open({
        ...baseOptions,
        layout: "modal"
      });
    });
  </script>
</body>
</html>
