<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChatGPT Time — OpenAI Total</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/app.css" />
</head>
<body>
  <header class="container">
    <h1>ChatGPT Usage — OpenAI Total Time</h1>
    <p class="muted" id="fileMeta">Analyzing…</p>
  </header>

  <main class="container">
    <section class="card">
      <div id="status" class="status">Requesting OpenAI analysis…</div>

      <div id="results" class="grid two" hidden>
        <div class="stat">
          <div class="label">Total Hours</div>
          <div class="value" id="hoursAI">—</div>
        </div>
        <div class="stat">
          <div class="label">Sessions</div>
          <div class="value" id="sessionsAI">—</div>
        </div>
      </div>

      <div id="timeframe" class="meta" hidden>
        <div><strong>First activity:</strong> <span id="firstTs">—</span></div>
        <div><strong>Last activity:</strong> <span id="lastTs">—</span></div>
      </div>

      <!-- New error preview section -->
      <div id="errorBox" class="card subtle" hidden>
        <div class="label">Error details</div>
        <pre id="errorJson"></pre>
      </div>

      <div id="raw" class="code card subtle" hidden>
        <div class="label">Raw OpenAI response</div>
        <pre id="rawJson"></pre>
      </div>

      <div class="actions">
        <a class="btn" href="./index.html">Upload another file</a>
        <button class="btn ghost" id="toggleRaw">Show raw</button>
      </div>
    </section>
  </main>

  <footer class="container footnote">
    Computed by OpenAI using a 30-minute session gap rule.
  </footer>

  <script>
    const ANALYZE = '/api/analyze';
    const qs = new URLSearchParams(location.search);
    const fileUrl = qs.get('fileUrl');
    const name = qs.get('name') || 'uploaded.json';

    const $ = (id) => document.getElementById(id);
    $('fileMeta').textContent = `File: ${name}`;
    $('toggleRaw').addEventListener('click', () => {
      const raw = $('raw');
      raw.hidden = !raw.hidden;
      $('toggleRaw').textContent = raw.hidden ? 'Show raw' : 'Hide raw';
    });

    (async () => {
      const statusEl = $('status');
      if (!fileUrl) { statusEl.textContent = 'Missing fileUrl in query string.'; return; }

      try {
        statusEl.textContent = 'Analyzing with OpenAI…';
        const res = await fetch(ANALYZE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileUrl, useOpenAI: true, filename: name })
        });
        const data = await res.json();
        $('rawJson').textContent = JSON.stringify(data, null, 2);

        if (!res.ok || data.error) {
          statusEl.textContent = 'Error: ' + (data.error || 'OpenAI analysis failed');
          $('errorBox').hidden = false;
          $('errorJson').textContent = JSON.stringify({
            error: data.error,
            preview: data.preview,
            length: data.length
          }, null, 2);
          $('raw').hidden = false;
          return;
        }

        const ai = data.openai && !data.openai.error ? data.openai : null;
        if (!ai) {
          statusEl.textContent = 'OpenAI response missing. Check OPENAI_API_KEY.';
          $('raw').hidden = false;
          return;
        }

        $('hoursAI').textContent    = ai?.total_hours != null ? Number(ai.total_hours).toFixed(2) : '—';
        $('sessionsAI').textContent = ai?.sessions ?? '—';

        if (ai.first || ai.last) {
          $('firstTs').textContent = ai.first ? new Date(ai.first).toLocaleString() : '—';
          $('lastTs').textContent  = ai.last  ? new Date(ai.last).toLocaleString()  : '—';
          $('timeframe').hidden = false;
        }

        statusEl.textContent = 'Done.';
        $('results').hidden = false;
      } catch (e) {
        $('status').textContent = 'Error: ' + e.message;
        $('raw').hidden = false;
      }
    })();
  </script>
</body>
</html>
